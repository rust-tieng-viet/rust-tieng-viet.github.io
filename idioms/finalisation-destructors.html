<!DOCTYPE HTML>
<html lang="vi" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Finalisation in destructors - Rust Tiếng Việt</title>


        <!-- Custom HTML head -->
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-88RKF7DLPY"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
        
          gtag('config', 'G-88RKF7DLPY');
        </script>
        
        <!-- pageview.js -->
        <script>
          !function(e,n,t){e.onload=function(){
          let e=n.createElement("script");
          e.src=t,n.body.appendChild(e)}}
          (window,document,"https://pageview.duyet.net/pageview.js");
        </script>
        
        <script async src="https://seline.duyet.workers.dev/seline.js" data-api-host="https://seline.duyet.workers.dev" data-token="d7c8002f8e40139"></script>
        <script async src="https://cm43xj8zd00093b619ak2zfuc.d.jitsu.com/p.js"></script>

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Rust Tiếng Việt</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-tieng-viet/rust-tieng-viet.github.io" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-tieng-viet/rust-tieng-viet.github.io/edit/main/src/idioms/finalisation-destructors.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="finalisation-in-destructors"><a class="header" href="#finalisation-in-destructors">Finalisation in Destructors</a></h1>
<p>Trong Rust, destructors (hay còn gọi là "drop handlers") được gọi tự động khi một value ra khỏi scope. Điều này cho phép chúng ta thực hiện các tác vụ cleanup một cách tự động và an toàn.</p>
<h2 id="drop-trait"><a class="header" href="#drop-trait">Drop Trait</a></h2>
<p>Rust cung cấp <a href="https://doc.rust-lang.org/std/ops/trait.Drop.html"><code>Drop</code> trait</a> để customize hành vi khi một value bị dropped:</p>
<pre><pre class="playground"><code class="language-rust edition2021">struct FileHandler {
    filename: String,
}

impl Drop for FileHandler {
    fn drop(&amp;mut self) {
        println!("Closing file: {}", self.filename);
        // Cleanup code ở đây
    }
}

fn main() {
    let handler = FileHandler {
        filename: "data.txt".to_string(),
    };
    println!("Working with file...");

    // Khi handler ra khỏi scope, drop() sẽ được gọi tự động
}
// Output:
// Working with file...
// Closing file: data.txt</code></pre></pre>
<h2 id="use-cases-phổ-biến"><a class="header" href="#use-cases-phổ-biến">Use Cases phổ biến</a></h2>
<h3 id="1-resource-management-raii-pattern"><a class="header" href="#1-resource-management-raii-pattern">1. Resource Management (RAII Pattern)</a></h3>
<p>RAII (Resource Acquisition Is Initialization) là một pattern quan trọng trong Rust:</p>
<pre><pre class="playground"><code class="language-rust edition2021">use std::fs::File;
use std::io::Write;

struct Logger {
    file: File,
}

impl Logger {
    fn new(path: &amp;str) -&gt; std::io::Result&lt;Self&gt; {
        Ok(Logger {
            file: File::create(path)?,
        })
    }

    fn log(&amp;mut self, message: &amp;str) -&gt; std::io::Result&lt;()&gt; {
        writeln!(self.file, "{}", message)
    }
}

impl Drop for Logger {
    fn drop(&amp;mut self) {
        writeln!(self.file, "Logger closed").ok();
        // File sẽ tự động được đóng khi ra khỏi scope
    }
}

fn main() -&gt; std::io::Result&lt;()&gt; {
    {
        let mut logger = Logger::new("app.log")?;
        logger.log("Application started")?;
        logger.log("Processing data")?;
        // Logger tự động flush và đóng file khi ra khỏi scope
    }

    Ok(())
}</code></pre></pre>
<h3 id="2-lock-management"><a class="header" href="#2-lock-management">2. Lock Management</a></h3>
<p>Sử dụng Drop để tự động release locks:</p>
<pre><pre class="playground"><code class="language-rust edition2021">use std::sync::{Arc, Mutex};
use std::thread;

fn main() {
    let data = Arc::new(Mutex::new(vec![1, 2, 3]));
    let mut handles = vec![];

    for i in 0..3 {
        let data = Arc::clone(&amp;data);
        let handle = thread::spawn(move || {
            let mut locked_data = data.lock().unwrap();
            locked_data.push(i);
            // Lock tự động được release khi locked_data ra khỏi scope
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("Result: {:?}", *data.lock().unwrap());
}</code></pre></pre>
<h3 id="3-connection-pooling"><a class="header" href="#3-connection-pooling">3. Connection Pooling</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021">struct DatabaseConnection {
    id: u32,
}

impl DatabaseConnection {
    fn new(id: u32) -&gt; Self {
        println!("Opening database connection #{}", id);
        DatabaseConnection { id }
    }

    fn execute(&amp;self, query: &amp;str) {
        println!("Connection #{} executing: {}", self.id, query);
    }
}

impl Drop for DatabaseConnection {
    fn drop(&amp;mut self) {
        println!("Closing database connection #{}", self.id);
        // Return connection to pool
    }
}

fn main() {
    {
        let conn = DatabaseConnection::new(1);
        conn.execute("SELECT * FROM users");
        // Connection tự động được trả về pool khi ra khỏi scope
    }
    println!("Connection has been returned to pool");
}</code></pre></pre>
<h2 id="thứ-tự-drop"><a class="header" href="#thứ-tự-drop">Thứ tự Drop</a></h2>
<p>Rust drop các values theo thứ tự ngược lại với thứ tự chúng được tạo ra:</p>
<pre><pre class="playground"><code class="language-rust edition2021">struct PrintOnDrop(&amp;'static str);

impl Drop for PrintOnDrop {
    fn drop(&amp;mut self) {
        println!("Dropping: {}", self.0);
    }
}

fn main() {
    let _first = PrintOnDrop("First");
    let _second = PrintOnDrop("Second");
    let _third = PrintOnDrop("Third");

    println!("End of main");
}
// Output:
// End of main
// Dropping: Third
// Dropping: Second
// Dropping: First</code></pre></pre>
<h2 id="drop-với-struct-fields"><a class="header" href="#drop-với-struct-fields">Drop với Struct Fields</a></h2>
<p>Fields trong một struct được dropped theo thứ tự khai báo:</p>
<pre><pre class="playground"><code class="language-rust edition2021">struct Container {
    first: PrintOnDrop,
    second: PrintOnDrop,
}

impl Drop for Container {
    fn drop(&amp;mut self) {
        println!("Dropping Container");
    }
}

fn main() {
    let _container = Container {
        first: PrintOnDrop("Field 1"),
        second: PrintOnDrop("Field 2"),
    };
}
// Output:
// Dropping Container
// Dropping: Field 1
// Dropping: Field 2</code></pre></pre>
<h2 id="manual-drop-với-stdmemdrop"><a class="header" href="#manual-drop-với-stdmemdrop">Manual Drop với <code>std::mem::drop</code></a></h2>
<p>Đôi khi cần drop một value trước khi nó ra khỏi scope:</p>
<pre><pre class="playground"><code class="language-rust edition2021">fn main() {
    let handler = FileHandler {
        filename: "data.txt".to_string(),
    };

    println!("Before manual drop");
    drop(handler); // Gọi destructor ngay lập tức
    println!("After manual drop");

    // handler không còn tồn tại ở đây
}</code></pre></pre>
<h2 id="lưu-ý-quan-trọng"><a class="header" href="#lưu-ý-quan-trọng">Lưu ý quan trọng</a></h2>
<h3 id="1-không-thể-gọi-drop-trực-tiếp"><a class="header" href="#1-không-thể-gọi-drop-trực-tiếp">1. Không thể gọi <code>drop()</code> trực tiếp</a></h3>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// ❌ Sai: không thể gọi drop() method trực tiếp
// handler.drop(); // Compile error!

// ✅ Đúng: sử dụng std::mem::drop
drop(handler);
<span class="boring">}</span></code></pre></pre>
<h3 id="2-drop-không-được-gọi-trong-panic"><a class="header" href="#2-drop-không-được-gọi-trong-panic">2. Drop không được gọi trong panic</a></h3>
<p>Nếu panic xảy ra trong <code>drop()</code>, chương trình sẽ abort:</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Drop for Risky {
    fn drop(&amp;mut self) {
        // Tránh panic trong drop!
        if let Err(e) = self.cleanup() {
            eprintln!("Cleanup failed: {}", e);
            // Log error nhưng không panic
        }
    }
}
<span class="boring">}</span></code></pre></pre>
<h3 id="3-copy-types-không-có-drop"><a class="header" href="#3-copy-types-không-có-drop">3. Copy types không có Drop</a></h3>
<p>Types implement <code>Copy</code> không thể implement <code>Drop</code>:</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// ❌ Compile error: Copy và Drop không thể cùng tồn tại
#[derive(Copy, Clone)]
struct CopyType {
    value: i32,
}

impl Drop for CopyType {
    fn drop(&amp;mut self) {
        // Error: Copy type cannot implement Drop
    }
}
<span class="boring">}</span></code></pre></pre>
<h2 id="best-practices"><a class="header" href="#best-practices">Best Practices</a></h2>
<ol>
<li><strong>Giữ <code>drop()</code> đơn giản</strong>: Tránh logic phức tạp trong destructor</li>
<li><strong>Không panic</strong>: Handle errors gracefully trong <code>drop()</code></li>
<li><strong>Sử dụng RAII</strong>: Tự động quản lý resources thông qua scope</li>
<li><strong>Document behavior</strong>: Ghi rõ side effects của destructor</li>
</ol>
<h2 id="ví-dụ-thực-tế-guard-pattern"><a class="header" href="#ví-dụ-thực-tế-guard-pattern">Ví dụ thực tế: Guard Pattern</a></h2>
<pre><pre class="playground"><code class="language-rust edition2021">use std::fs::File;
use std::io::Write;

struct FileGuard {
    file: Option&lt;File&gt;,
    path: String,
}

impl FileGuard {
    fn new(path: &amp;str) -&gt; std::io::Result&lt;Self&gt; {
        Ok(FileGuard {
            file: Some(File::create(path)?),
            path: path.to_string(),
        })
    }

    fn write(&amp;mut self, data: &amp;str) -&gt; std::io::Result&lt;()&gt; {
        if let Some(ref mut file) = self.file {
            writeln!(file, "{}", data)
        } else {
            Err(std::io::Error::new(
                std::io::ErrorKind::Other,
                "File already closed",
            ))
        }
    }
}

impl Drop for FileGuard {
    fn drop(&amp;mut self) {
        if let Some(file) = self.file.take() {
            drop(file); // Explicit flush
            println!("File '{}' has been closed", self.path);
        }
    }
}

fn main() -&gt; std::io::Result&lt;()&gt; {
    let mut guard = FileGuard::new("output.txt")?;
    guard.write("Hello")?;
    guard.write("World")?;

    // File sẽ tự động được flush và close
    Ok(())
}</code></pre></pre>
<h2 id="tham-khảo"><a class="header" href="#tham-khảo">Tham khảo</a></h2>
<ul>
<li><a href="https://doc.rust-lang.org/book/ch15-03-drop.html">The Drop Trait</a></li>
<li><a href="https://doc.rust-lang.org/std/ops/trait.Drop.html">std::ops::Drop</a></li>
<li><a href="https://doc.rust-lang.org/std/mem/fn.drop.html">std::mem::drop</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../idioms/default-trait.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../idioms/temporary-mutability.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../idioms/default-trait.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../idioms/temporary-mutability.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../editor.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
